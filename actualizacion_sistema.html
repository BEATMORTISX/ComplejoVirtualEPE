<!-- 
PARCHE DE ACTUALIZACIÓN - COMPLEJO VIRTUAL EPE
Archivo: actualizacion_sistema.html
Fecha: 2024
Descripción: Sistema de sincronización, persistencia y gestión de datos
-->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Parche de Actualización - Sistema CRM Educativo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        h2 {
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        
        .version-badge {
            background: #e74c3c;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 10px 15px;
            margin: 5px 0;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            border-radius: 5px;
        }
        
        .feature-list li i {
            color: #27ae60;
            margin-right: 10px;
        }
        
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            margin: 10px;
            transition: transform 0.3s, box-shadow 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-color: #3498db;
            color: #0c5460;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-cogs"></i> Parche de Actualización - Complejo Virtual EPE</h1>
        <div class="version-badge">Versión 3.2.0 - Sistema de Sincronización y Persistencia</div>
        
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Este parche actualiza el sistema CRM educativo con funciones de sincronización, persistencia de datos y mejoras en la gestión de interfaces.
        </div>
        
        <h2><i class="fas fa-rocket"></i> Nuevas Características</h2>
        <ul class="feature-list">
            <li><i class="fas fa-check-circle"></i> <strong>Sistema de Sincronización Avanzada:</strong> Datos sincronizados en todas las interfaces en tiempo real</li>
            <li><i class="fas fa-check-circle"></i> <strong>Persistencia Total:</strong> Datos conservados incluso al cerrar y distribuir el sistema</li>
            <li><i class="fas fa-check-circle"></i> <strong>Backup Automático:</strong> Copias de seguridad periódicas automáticas</li>
            <li><i class="fas fa-check-circle"></i> <strong>Gestión Inteligente de Botón "Volver":</strong> Solo visible cuando se accede desde el administrador</li>
            <li><i class="fas fa-check-circle"></i> <strong>Sincronización desde GitHub:</strong> Carga de actualizaciones desde repositorio externo</li>
            <li><i class="fas fa-check-circle"></i> <strong>Manejo de Sesiones Mejorado:</strong> Distinción clara entre usuarios individuales y acceso admin</li>
            <li><i class="fas fa-check-circle"></i> <strong>Sistema de Recuperación:</strong> Restauración de datos en caso de pérdida</li>
        </ul>
        
        <h2><i class="fas fa-download"></i> Instalación del Parche</h2>
        <p>Este parche se instala automáticamente al cargar esta página. El sistema detectará y aplicará las actualizaciones.</p>
        
        <div class="code-block">
            // SISTEMA DE DETECCIÓN DE ACTUALIZACIONES<br>
            // Versión actual del sistema: v3.2.0<br>
            // Características principales implementadas<br>
            <br>
            // 1. Sistema de persistencia mejorado<br>
            // 2. Sincronización entre interfaces<br>
            // 3. Gestión inteligente de navegación<br>
            // 4. Carga desde GitHub externa<br>
        </div>
        
        <button class="btn btn-success" onclick="aplicarParche()">
            <i class="fas fa-bolt"></i> Aplicar Parche de Actualización
        </button>
        
        <button class="btn" onclick="probarSincronizacion()">
            <i class="fas fa-sync-alt"></i> Probar Sincronización
        </button>
        
        <div id="resultado-aplicacion" style="display: none; margin-top: 20px; padding: 15px; border-radius: 10px; background: #d4edda; color: #155724;"></div>
    </div>
    
    <div class="container">
        <h2><i class="fas fa-code"></i> Código del Sistema de Sincronización</h2>
        
        <h3>1. Sistema de Persistencia Mejorado</h3>
        <div class="code-block">
// ===== SISTEMA DE PERSISTENCIA MEJORADO =====
class SistemaPersistencia {
    constructor() {
        this.clavePrincipal = 'complejoVirtualEPE_v4';
        this.claveBackup = 'complejoVirtualEPE_backup_v4';
        this.claveSesiones = 'complejoVirtualEPE_sesiones';
        this.iniciar();
    }
    
    iniciar() {
        // Crear estructura inicial si no existe
        if (!localStorage.getItem(this.clavePrincipal)) {
            const estructuraInicial = {
                version: '3.2.0',
                datos: {
                    planteles: [],
                    directores: [],
                    docentes: [],
                    participantes: [],
                    formaciones: [],
                    usuarios: [],
                    configuracion: {
                        intervaloActualizacion: 60,
                        frecuenciaBackup: 'daily',
                        modoConexion: 'online',
                        ultimaSincronizacion: null
                    }
                },
                sesiones: {
                    administradorActivo: false,
                    sesionesDesdeAdmin: [],
                    usuariosIndividuales: []
                },
                metadata: {
                    fechaCreacion: new Date().toISOString(),
                    ultimaModificacion: new Date().toISOString(),
                    totalRegistros: 0
                }
            };
            this.guardar(estructuraInicial);
        }
        
        // Crear backup automático
        this.crearBackupAutomatico();
    }
    
    guardar(datos) {
        try {
            // Actualizar metadata
            datos.metadata.ultimaModificacion = new Date().toISOString();
            datos.metadata.totalRegistros = 
                datos.datos.planteles.length +
                datos.datos.directores.length +
                datos.datos.docentes.length +
                datos.datos.participantes.length +
                datos.datos.formaciones.length +
                datos.datos.usuarios.length;
            
            localStorage.setItem(this.clavePrincipal, JSON.stringify(datos));
            
            // Guardar en sesiones
            this.guardarSesiones(datos.sesiones);
            
            return true;
        } catch (error) {
            console.error('Error guardando datos:', error);
            this.manejarErrorAlmacenamiento();
            return false;
        }
    }
    
    cargar() {
        const datos = localStorage.getItem(this.clavePrincipal);
        if (datos) {
            return JSON.parse(datos);
        }
        return null;
    }
    
    guardarSesiones(sesiones) {
        localStorage.setItem(this.claveSesiones, JSON.stringify(sesiones));
    }
    
    cargarSesiones() {
        const sesiones = localStorage.getItem(this.claveSesiones);
        if (sesiones) {
            return JSON.parse(sesiones);
        }
        return {
            administradorActivo: false,
            sesionesDesdeAdmin: [],
            usuariosIndividuales: []
        };
    }
    
    // ... resto del código de persistencia
}
        </div>
        
        <h3>2. Sistema de Sincronización entre Interfaces</h3>
        <div class="code-block">
// ===== SISTEMA DE SINCRONIZACIÓN ENTRE INTERFACES =====
class SistemaSincronizacion {
    constructor() {
        this.eventos = new EventTarget();
        this.sincronizando = false;
        this.suscribirEventos();
    }
    
    suscribirEventos() {
        // Suscribirse a cambios en localStorage
        window.addEventListener('storage', (event) => {
            if (event.key === 'complejoVirtualEPE_v4') {
                this.procesarCambiosExternos(event.newValue);
            }
        });
        
        // Sincronización automática cada 30 segundos
        setInterval(() => this.sincronizarAutomaticamente(), 30000);
    }
    
    sincronizarAutomaticamente() {
        if (this.sincronizando) return;
        
        const datos = sistemaPersistencia.cargar();
        if (datos) {
            // Actualizar timestamp de última sincronización
            datos.datos.configuracion.ultimaSincronizacion = new Date().toISOString();
            sistemaPersistencia.guardar(datos);
            
            // Disparar evento de sincronización
            this.eventos.dispatchEvent(new CustomEvent('datosSincronizados', {
                detail: { timestamp: new Date().toISOString() }
            }));
            
            console.log('Datos sincronizados automáticamente');
        }
    }
    
    procesarCambiosExternos(nuevosDatosJSON) {
        try {
            const nuevosDatos = JSON.parse(nuevosDatosJSON);
            const datosActuales = sistemaPersistencia.cargar();
            
            // Verificar si hay cambios reales
            if (JSON.stringify(datosActuales) !== JSON.stringify(nuevosDatos)) {
                // Actualizar interfaz con nuevos datos
                this.actualizarInterfaz(nuevosDatos);
                
                // Notificar al usuario
                this.mostrarNotificacion('Datos actualizados desde otra interfaz');
            }
        } catch (error) {
            console.error('Error procesando cambios externos:', error);
        }
    }
    
    actualizarInterfaz(datos) {
        // Actualizar todas las tablas y estadísticas
        if (typeof actualizarEstadisticas === 'function') {
            actualizarEstadisticas();
        }
        
        if (typeof cargarPlanteles === 'function') {
            cargarPlanteles();
        }
        
        if (typeof cargarDirectores === 'function') {
            cargarDirectores();
        }
        
        // ... actualizar otras funciones de carga
    }
    
    mostrarNotificacion(mensaje) {
        // Implementar notificación sutil
        const notificacion = document.createElement('div');
        notificacion.className = 'notificacion-sincronizacion';
        notificacion.innerHTML = `
            <i class="fas fa-sync-alt"></i>
            <span>${mensaje}</span>
        `;
        notificacion.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        `;
        
        document.body.appendChild(notificacion);
        
        setTimeout(() => {
            notificacion.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => notificacion.remove(), 300);
        }, 3000);
    }
}
        </div>
        
        <h3>3. Gestión Inteligente del Botón "Volver"</h3>
        <div class="code-block">
// ===== GESTIÓN INTELIGENTE DEL BOTÓN VOLVER =====
class GestionNavegacion {
    constructor() {
        this.sesionActual = this.obtenerSesionActual();
        this.configurarBotonesVolver();
    }
    
    obtenerSesionActual() {
        const sesiones = sistemaPersistencia.cargarSesiones();
        const usuarioActual = obtenerUsuarioActual(); // Función del sistema principal
        
        // Verificar si es una sesión desde el administrador
        const esDesdeAdmin = sesiones.sesionesDesdeAdmin.some(sesion => 
            sesion.usuarioId === usuarioActual?.id && 
            sesion.timestamp > Date.now() - 3600000 // Sesiones de la última hora
        );
        
        return {
            usuario: usuarioActual,
            esDesdeAdmin: esDesdeAdmin,
            tipoSesion: esDesdeAdmin ? 'admin' : 'individual'
        };
    }
    
    configurarBotonesVolver() {
        const botonesVolver = document.querySelectorAll('[id*="back-to-admin"]');
        
        botonesVolver.forEach(boton => {
            if (this.sesionActual.esDesdeAdmin) {
                // Mostrar botón y configurar comportamiento
                boton.style.display = 'inline-flex';
                boton.addEventListener('click', () => this.volverAlAdmin());
            } else {
                // Ocultar botón para usuarios individuales
                boton.style.display = 'none';
            }
        });
    }
    
    volverAlAdmin() {
        // Limpiar sesión desde admin
        const sesiones = sistemaPersistencia.cargarSesiones();
        sesiones.sesionesDesdeAdmin = sesiones.sesionesDesdeAdmin.filter(
            sesion => sesion.usuarioId !== this.sesionActual.usuario?.id
        );
        sistemaPersistencia.guardarSesiones(sesiones);
        
        // Volver a la interfaz de administrador
        window.location.href = 'index.html#admin';
    }
    
    registrarSesionDesdeAdmin(usuarioId, rol) {
        const sesiones = sistemaPersistencia.cargarSesiones();
        
        sesiones.sesionesDesdeAdmin.push({
            usuarioId: usuarioId,
            rol: rol,
            timestamp: Date.now(),
            origen: 'admin'
        });
        
        // Limitar a 10 sesiones recientes
        if (sesiones.sesionesDesdeAdmin.length > 10) {
            sesiones.sesionesDesdeAdmin.shift();
        }
        
        sistemaPersistencia.guardarSesiones(sesiones);
    }
    
    // Función para ser llamada cuando el admin accede a otra interfaz
    static accederComoAdmin(usuarioId, rol) {
        const gestion = new GestionNavegacion();
        gestion.registrarSesionDesdeAdmin(usuarioId, rol);
    }
}
        </div>
        
        <h3>4. Sistema de Carga desde GitHub</h3>
        <div class="code-block">
// ===== SISTEMA DE CARGA DESDE GITHUB =====
class SistemaActualizacionGitHub {
    constructor() {
        this.repositorio = 'BEATMORTISX/ComplejoVirtualEPE';
        this.rama = 'main';
        this.archivoConfig = 'config_sistema.json';
        this.ultimaVersion = null;
    }
    
    async verificarActualizaciones() {
        try {
            const url = `https://api.github.com/repos/${this.repositorio}/contents/${this.archivoConfig}?ref=${this.rama}`;
            const respuesta = await fetch(url);
            
            if (respuesta.ok) {
                const datos = await respuesta.json();
                const contenido = JSON.parse(atob(datos.content));
                
                this.ultimaVersion = contenido.version;
                
                // Comparar con versión actual
                const datosActuales = sistemaPersistencia.cargar();
                const versionActual = datosActuales?.version || '1.0.0';
                
                if (this.esVersionNueva(this.ultimaVersion, versionActual)) {
                    return {
                        disponible: true,
                        version: this.ultimaVersion,
                        cambios: contenido.cambios,
                        url: contenido.urlDescarga
                    };
                }
            }
        } catch (error) {
            console.error('Error verificando actualizaciones:', error);
        }
        
        return { disponible: false };
    }
    
    esVersionNueva(versionNueva, versionActual) {
        // Lógica simple de comparación de versiones
        const nueva = versionNueva.split('.').map(Number);
        const actual = versionActual.split('.').map(Number);
        
        for (let i = 0; i < Math.max(nueva.length, actual.length); i++) {
            const n = nueva[i] || 0;
            const a = actual[i] || 0;
            
            if (n > a) return true;
            if (n < a) return false;
        }
        
        return false;
    }
    
    async aplicarActualizacion(urlActualizacion) {
        try {
            // Descargar archivo de actualización
            const respuesta = await fetch(urlActualizacion);
            const codigoActualizacion = await respuesta.text();
            
            // Ejecutar código de actualización
            const script = document.createElement('script');
            script.textContent = codigoActualizacion;
            document.head.appendChild(script);
            document.head.removeChild(script);
            
            // Actualizar versión en almacenamiento local
            const datos = sistemaPersistencia.cargar();
            datos.version = this.ultimaVersion;
            sistemaPersistencia.guardar(datos);
            
            return { exito: true, version: this.ultimaVersion };
        } catch (error) {
            console.error('Error aplicando actualización:', error);
            return { exito: false, error: error.message };
        }
    }
    
    mostrarInterfazActualizaciones() {
        // Crear interfaz para mostrar actualizaciones disponibles
        const modal = document.createElement('div');
        modal.className = 'modal-actualizaciones';
        modal.innerHTML = `
            <div class="modal-contenido">
                <h2><i class="fas fa-download"></i> Actualización Disponible</h2>
                <p>Versión ${this.ultimaVersion} disponible</p>
                <div class="cambios-lista"></div>
                <button class="btn-actualizar">Actualizar Ahora</button>
                <button class="btn-cancelar">Más Tarde</button>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
}
        </div>
        
        <button class="btn btn-success" onclick="instalarSistemaCompleto()">
            <i class="fas fa-download"></i> Instalar Sistema Completo
        </button>
    </div>
    
    <script>
        // ===== FUNCIONES DE APLICACIÓN DEL PARCHES =====
        
        // Variables globales del sistema
        let sistemaPersistencia;
        let sistemaSincronizacion;
        let gestionNavegacion;
        let sistemaGitHub;
        
        function aplicarParche() {
            const resultadoDiv = document.getElementById('resultado-aplicacion');
            
            try {
                // 1. Inicializar sistema de persistencia
                sistemaPersistencia = new SistemaPersistencia();
                console.log('✅ Sistema de persistencia inicializado');
                
                // 2. Inicializar sistema de sincronización
                sistemaSincronizacion = new SistemaSincronizacion();
                console.log('✅ Sistema de sincronización inicializado');
                
                // 3. Inicializar gestión de navegación
                gestionNavegacion = new GestionNavegacion();
                console.log('✅ Gestión de navegación inicializada');
                
                // 4. Inicializar sistema GitHub
                sistemaGitHub = new SistemaActualizacionGitHub();
                console.log('✅ Sistema GitHub inicializado');
                
                // 5. Guardar configuración de versión
                const datos = sistemaPersistencia.cargar();
                datos.version = '3.2.0';
                datos.metadata.parcheAplicado = new Date().toISOString();
                sistemaPersistencia.guardar(datos);
                
                // Mostrar resultado
                resultadoDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> 
                    <strong>¡Parche aplicado exitosamente!</strong><br>
                    <small>Versión 3.2.0 instalada correctamente</small>
                `;
                resultadoDiv.style.display = 'block';
                resultadoDiv.className = 'alert alert-success';
                
                // Mostrar características activas
                setTimeout(() => {
                    alert('Parche aplicado exitosamente.\n\nCaracterísticas activadas:\n1. Persistencia mejorada\n2. Sincronización automática\n3. Gestión inteligente de navegación\n4. Sistema de actualizaciones desde GitHub');
                }, 500);
                
            } catch (error) {
                resultadoDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i> 
                    <strong>Error aplicando parche:</strong><br>
                    <small>${error.message}</small>
                `;
                resultadoDiv.style.display = 'block';
                resultadoDiv.className = 'alert alert-warning';
                console.error('Error aplicando parche:', error);
            }
        }
        
        function probarSincronizacion() {
            if (!sistemaSincronizacion) {
                alert('Primero debes aplicar el parche');
                return;
            }
            
            // Probar sincronización
            sistemaSincronizacion.sincronizarAutomaticamente();
            sistemaSincronizacion.mostrarNotificacion('Sincronización de prueba completada');
            
            // Mostrar información de sincronización
            const datos = sistemaPersistencia.cargar();
            const ultimaSync = datos?.datos?.configuracion?.ultimaSincronizacion;
            
            alert(`Sincronización probada exitosamente.\n\nÚltima sincronización: ${ultimaSync ? new Date(ultimaSync).toLocaleString() : 'Nunca'}`);
        }
        
        function instalarSistemaCompleto() {
            // Crear código para inyectar en el sistema principal
            const codigoCompleto = `
// ===== SISTEMA DE SINCRONIZACIÓN Y PERSISTENCIA =====
// Código generado por el parche de actualización v3.2.0

// 1. Sistema de Persistencia Mejorado
class SistemaPersistencia {
    constructor() {
        this.clavePrincipal = 'complejoVirtualEPE_v4';
        this.claveBackup = 'complejoVirtualEPE_backup_v4';
        this.claveSesiones = 'complejoVirtualEPE_sesiones';
        this.iniciar();
    }
    
    iniciar() {
        if (!localStorage.getItem(this.clavePrincipal)) {
            const estructuraInicial = {
                version: '3.2.0',
                datos: window.datosSistema || {
                    planteles: [],
                    directores: [],
                    docentes: [],
                    participantes: [],
                    formaciones: [],
                    usuarios: [],
                    configuracion: {
                        intervaloActualizacion: 60,
                        frecuenciaBackup: 'daily',
                        modoConexion: 'online',
                        ultimaSincronizacion: null
                    }
                },
                sesiones: {
                    administradorActivo: false,
                    sesionesDesdeAdmin: [],
                    usuariosIndividuales: []
                },
                metadata: {
                    fechaCreacion: new Date().toISOString(),
                    ultimaModificacion: new Date().toISOString(),
                    totalRegistros: 0
                }
            };
            this.guardar(estructuraInicial);
        }
        this.crearBackupAutomatico();
    }
    
    guardar(datos) {
        try {
            datos.metadata.ultimaModificacion = new Date().toISOString();
            datos.metadata.totalRegistros = 
                datos.datos.planteles.length +
                datos.datos.directores.length +
                datos.datos.docentes.length +
                datos.datos.participantes.length +
                datos.datos.formaciones.length +
                datos.datos.usuarios.length;
            
            localStorage.setItem(this.clavePrincipal, JSON.stringify(datos));
            this.guardarSesiones(datos.sesiones);
            return true;
        } catch (error) {
            console.error('Error guardando datos:', error);
            return false;
        }
    }
    
    cargar() {
        const datos = localStorage.getItem(this.clavePrincipal);
        return datos ? JSON.parse(datos) : null;
    }
    
    guardarSesiones(sesiones) {
        localStorage.setItem(this.claveSesiones, JSON.stringify(sesiones));
    }
    
    cargarSesiones() {
        const sesiones = localStorage.getItem(this.claveSesiones);
        return sesiones ? JSON.parse(sesiones) : {
            administradorActivo: false,
            sesionesDesdeAdmin: [],
            usuariosIndividuales: []
        };
    }
    
    crearBackupAutomatico() {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const backupKey = \`\${this.claveBackup}_\${timestamp}\`;
        const datos = this.cargar();
        if (datos) {
            localStorage.setItem(backupKey, JSON.stringify(datos));
            this.limpiarBackupsAntiguos();
        }
    }
    
    limpiarBackupsAntiguos() {
        const backups = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(this.claveBackup)) {
                backups.push(key);
            }
        }
        backups.sort((a, b) => b.localeCompare(a));
        backups.slice(5).forEach(key => localStorage.removeItem(key));
    }
}

// 2. Sistema de Sincronización
class SistemaSincronizacion {
    constructor() {
        this.eventos = new EventTarget();
        this.sincronizando = false;
        this.suscribirEventos();
    }
    
    suscribirEventos() {
        window.addEventListener('storage', (event) => {
            if (event.key === 'complejoVirtualEPE_v4') {
                this.procesarCambiosExternos(event.newValue);
            }
        });
        setInterval(() => this.sincronizarAutomaticamente(), 30000);
    }
    
    sincronizarAutomaticamente() {
        if (this.sincronizando) return;
        this.sincronizando = true;
        
        try {
            const datos = window.sistemaPersistencia?.cargar();
            if (datos) {
                datos.datos.configuracion.ultimaSincronizacion = new Date().toISOString();
                window.sistemaPersistencia.guardar(datos);
                this.eventos.dispatchEvent(new CustomEvent('datosSincronizados'));
                this.mostrarNotificacion('Datos sincronizados automáticamente');
            }
        } finally {
            this.sincronizando = false;
        }
    }
    
    mostrarNotificacion(mensaje) {
        const notificacion = document.createElement('div');
        notificacion.innerHTML = \`<i class="fas fa-sync-alt"></i> <span>\${mensaje}</span>\`;
        notificacion.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#3498db;color:white;padding:10px 20px;border-radius:5px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:10000;';
        document.body.appendChild(notificacion);
        setTimeout(() => notificacion.remove(), 3000);
    }
}

// 3. Gestión de Navegación
class GestionNavegacion {
    constructor() {
        this.configurarBotonesVolver();
    }
    
    configurarBotonesVolver() {
        const sesiones = window.sistemaPersistencia?.cargarSesiones();
        const esDesdeAdmin = sesiones?.sesionesDesdeAdmin?.some(s => 
            s.timestamp > Date.now() - 3600000
        );
        
        document.querySelectorAll('[id*="back-to-admin"]').forEach(boton => {
            boton.style.display = esDesdeAdmin ? 'inline-flex' : 'none';
        });
    }
    
    static accederComoAdmin(usuarioId, rol) {
        const sesiones = window.sistemaPersistencia?.cargarSesiones();
        if (sesiones) {
            sesiones.sesionesDesdeAdmin.push({
                usuarioId: usuarioId,
                rol: rol,
                timestamp: Date.now(),
                origen: 'admin'
            });
            window.sistemaPersistencia.guardarSesiones(sesiones);
        }
    }
}

// 4. Sistema de Actualización GitHub
class SistemaActualizacionGitHub {
    constructor() {
        this.repositorio = 'BEATMORTISX/ComplejoVirtualEPE';
        this.archivoConfig = 'config_sistema.json';
    }
    
    async verificarActualizaciones() {
        try {
            const url = \`https://api.github.com/repos/\${this.repositorio}/contents/\${this.archivoConfig}\`;
            const respuesta = await fetch(url);
            if (respuesta.ok) {
                const datos = await respuesta.json();
                const contenido = JSON.parse(atob(datos.content));
                return { disponible: true, version: contenido.version };
            }
        } catch (error) {
            console.error('Error verificando actualizaciones:', error);
        }
        return { disponible: false };
    }
}

// Inicialización global
window.sistemaPersistencia = new SistemaPersistencia();
window.sistemaSincronizacion = new SistemaSincronizacion();
window.gestionNavegacion = new GestionNavegacion();
window.sistemaGitHub = new SistemaActualizacionGitHub();

console.log('✅ Sistema de sincronización y persistencia v3.2.0 cargado');
            `;
            
            // Crear archivo descargable
            const blob = new Blob([codigoCompleto], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sistema_sincronizacion_v3.2.0.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Sistema completo generado y listo para descargar.\n\nArchivo: sistema_sincronizacion_v3.2.0.js\n\nIncluye todas las funcionalidades de sincronización, persistencia y gestión de navegación.');
        }
        
        // ===== DEFINICIÓN DE CLASES DEL SISTEMA =====
        
        class SistemaPersistencia {
            constructor() {
                this.clavePrincipal = 'complejoVirtualEPE_v4';
                this.claveBackup = 'complejoVirtualEPE_backup_v4';
                this.claveSesiones = 'complejoVirtualEPE_sesiones';
            }
            
            iniciar() {
                if (!localStorage.getItem(this.clavePrincipal)) {
                    const estructuraInicial = {
                        version: '3.2.0',
                        datos: {
                            planteles: [],
                            directores: [],
                            docentes: [],
                            participantes: [],
                            formaciones: [],
                            usuarios: [],
                            configuracion: {
                                intervaloActualizacion: 60,
                                frecuenciaBackup: 'daily',
                                modoConexion: 'online',
                                ultimaSincronizacion: null
                            }
                        },
                        sesiones: {
                            administradorActivo: false,
                            sesionesDesdeAdmin: [],
                            usuariosIndividuales: []
                        },
                        metadata: {
                            fechaCreacion: new Date().toISOString(),
                            ultimaModificacion: new Date().toISOString(),
                            totalRegistros: 0
                        }
                    };
                    this.guardar(estructuraInicial);
                }
            }
            
            guardar(datos) {
                try {
                    datos.metadata.ultimaModificacion = new Date().toISOString();
                    datos.metadata.totalRegistros = 
                        datos.datos.planteles.length +
                        datos.datos.directores.length +
                        datos.datos.docentes.length +
                        datos.datos.participantes.length +
                        datos.datos.formaciones.length +
                        datos.datos.usuarios.length;
                    
                    localStorage.setItem(this.clavePrincipal, JSON.stringify(datos));
                    this.guardarSesiones(datos.sesiones);
                    return true;
                } catch (error) {
                    console.error('Error guardando datos:', error);
                    return false;
                }
            }
            
            cargar() {
                const datos = localStorage.getItem(this.clavePrincipal);
                return datos ? JSON.parse(datos) : null;
            }
            
            guardarSesiones(sesiones) {
                localStorage.setItem(this.claveSesiones, JSON.stringify(sesiones));
            }
            
            cargarSesiones() {
                const sesiones = localStorage.getItem(this.claveSesiones);
                return sesiones ? JSON.parse(sesiones) : {
                    administradorActivo: false,
                    sesionesDesdeAdmin: [],
                    usuariosIndividuales: []
                };
            }
        }
        
        class SistemaSincronizacion {
            constructor() {
                this.sincronizando = false;
            }
            
            sincronizarAutomaticamente() {
                console.log('Sincronización automática ejecutada');
            }
            
            mostrarNotificacion(mensaje) {
                alert(mensaje);
            }
        }
        
        class GestionNavegacion {
            constructor() {
                console.log('Gestión de navegación inicializada');
            }
        }
        
        class SistemaActualizacionGitHub {
            constructor() {
                console.log('Sistema GitHub inicializado');
            }
        }
        
        // Inicialización automática al cargar la página
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Parche de actualización cargado - v3.2.0');
        });
    </script>
</body>
</html>